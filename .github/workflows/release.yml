name: æž„å»ºå’Œå‘å¸ƒ Release

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (å¦‚: v1.0.0)'
        required: false
        default: ''
  
  # æŽ¨é€ tag æ—¶è‡ªåŠ¨è§¦å‘
  push:
    tags:
      - 'v*.*.*'

# æ·»åŠ å¿…è¦çš„æƒé™ä»¥åˆ›å»º Release
permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: æž„å»º ${{ matrix.platform.target }}
    runs-on: ${{ matrix.platform.os }}
    
    strategy:
      fail-fast: false
      matrix:
        platform:
          # macOS Intel
          - target: x86_64-apple-darwin
            os: macos-latest
            name: project-manager-cli-macos-intel
          
          # macOS Apple Silicon
          - target: aarch64-apple-darwin
            os: macos-latest
            name: project-manager-cli-macos-arm64
          
          # Linux x86_64
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            name: project-manager-cli-linux-x86_64
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: å®‰è£… Rust å·¥å…·é“¾
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform.target }}
      
      - name: é…ç½® Rust ç¼“å­˜
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.platform.target }}
      
      - name: å®‰è£…äº¤å‰ç¼–è¯‘å·¥å…· (macOS)
        if: matrix.platform.os == 'macos-latest'
        run: |
          # macOS ä¸Šå®‰è£…äº¤å‰ç¼–è¯‘ç›®æ ‡
          rustup target add ${{ matrix.platform.target }}
      
      - name: å®‰è£…äº¤å‰ç¼–è¯‘å·¥å…· (Linux)
        if: matrix.platform.os == 'ubuntu-latest'
        run: |
          # Linux ä¸Šå®‰è£…å¿…è¦çš„ä¾èµ–
          sudo apt-get update
          sudo apt-get install -y build-essential
          rustup target add ${{ matrix.platform.target }}
      
      - name: è®¾ç½®OpenSSLçŽ¯å¢ƒå˜é‡ (macOS)
        if: matrix.platform.os == 'macos-latest'
        run: |
          # è®¾ç½®OpenSSLç›¸å…³çŽ¯å¢ƒå˜é‡ï¼Œæ”¯æŒäº¤å‰ç¼–è¯‘
          echo "OPENSSL_STATIC=1" >> $GITHUB_ENV
          echo "OPENSSL_LIB_DIR=/usr/lib" >> $GITHUB_ENV
          echo "OPENSSL_INCLUDE_DIR=/usr/include" >> $GITHUB_ENV
      
      - name: æž„å»ºé¡¹ç›®
        run: |
          cargo build --release --target ${{ matrix.platform.target }}
      
      - name: å‡†å¤‡å‘å¸ƒæ–‡ä»¶
        shell: bash
        run: |
          # åˆ›å»ºå‘å¸ƒç›®å½•
          mkdir -p release
          
          # è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶å
          if [[ "${{ matrix.platform.os }}" == "windows-latest" ]]; then
            EXECUTABLE="target/${{ matrix.platform.target }}/release/project-manager-cli.exe"
            RELEASE_NAME="${{ matrix.platform.name }}.exe"
          else
            EXECUTABLE="target/${{ matrix.platform.target }}/release/project-manager-cli"
            RELEASE_NAME="${{ matrix.platform.name }}"
          fi
          
          # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
          cp "$EXECUTABLE" "release/$RELEASE_NAME"
          
          # åˆ›å»ºåŽ‹ç¼©åŒ…
          cd release
          if [[ "${{ matrix.platform.os }}" == "macos-latest" ]]; then
            # macOS ä½¿ç”¨ tar.gz
            tar -czf "${{ matrix.platform.name }}.tar.gz" "$RELEASE_NAME"
          else
            # Linux ä½¿ç”¨ tar.gz
            tar -czf "${{ matrix.platform.name }}.tar.gz" "$RELEASE_NAME"
          fi
          
          # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
          ls -la
          file "$RELEASE_NAME" || true
      
      - name: ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform.name }}
          path: release/${{ matrix.platform.name }}.tar.gz
          retention-days: 7

  release:
    name: åˆ›å»º GitHub Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ä¸‹è½½æ‰€æœ‰æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: å‡†å¤‡å‘å¸ƒæ–‡ä»¶
        run: |
          # åˆ›å»ºå‘å¸ƒç›®å½•å¹¶æ•´ç†æ–‡ä»¶
          mkdir -p release-files
          find artifacts -name "*.tar.gz" -exec cp {} release-files/ \;
          
          # æ˜¾ç¤ºæ‰€æœ‰æ–‡ä»¶
          echo "=== å‘å¸ƒæ–‡ä»¶åˆ—è¡¨ ==="
          ls -la release-files/
      
      - name: ç¡®å®šç‰ˆæœ¬å·
        id: get_version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ github.event.inputs.version }}" ]]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" =~ refs/tags/(.*) ]]; then
            echo "version=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
          else
            echo "version=manual-$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
          fi
      
      - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## ðŸ“¦ Project Manager CLI ${{ steps.get_version.outputs.version }}
          
          ### ðŸš€ ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½é€‚åˆä½ ç³»ç»Ÿçš„ç‰ˆæœ¬
          2. è§£åŽ‹ç¼©æ–‡ä»¶
          3. ç›´æŽ¥è¿è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶å³å¯å¯åŠ¨ TUI ç•Œé¢
          
          ### ðŸ“‹ æ”¯æŒçš„å¹³å°
          - **macOS Intel (x86_64)**: `project-manager-cli-macos-intel.tar.gz`
          - **macOS Apple Silicon (ARM64)**: `project-manager-cli-macos-arm64.tar.gz`
          - **Linux x86_64**: `project-manager-cli-linux-x86_64.tar.gz`
          
          ### ðŸ’¡ åŠŸèƒ½ç‰¹æ€§
          - é»˜è®¤å¯åŠ¨ TUI äº¤äº’ç•Œé¢
          - é¡¹ç›®æ‰«æå’Œç®¡ç†åŠŸèƒ½
          - æ”¯æŒå¤šç§é¡¹ç›®ç±»åž‹æ£€æµ‹
          - å¯é…ç½®çš„æ‰«æå‚æ•°
          
          ### ðŸ”§ å‘½ä»¤è¡Œé€‰é¡¹
          ```bash
          # ç›´æŽ¥è¿è¡Œ - å¯åŠ¨ TUI ç•Œé¢
          ./project-manager-cli
          
          # æŒ‡å®šæ‰«æè·¯å¾„
          ./project-manager-cli /path/to/projects
          
          # å…¶ä»–å‘½ä»¤
          ./project-manager-cli scan        # æ‰«æé¡¹ç›®
          ./project-manager-cli config      # ç®¡ç†é…ç½®
          ./project-manager-cli clean       # æ¸…ç†é¡¹ç›®
          ```
          
          ---
          ðŸ¤– è‡ªåŠ¨æž„å»ºäºŽ: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          EOF
          
          echo "Release notes generated"
      
      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          name: "Project Manager CLI ${{ steps.get_version.outputs.version }}"
          body_path: release_notes.md
          files: release-files/*
          draft: false
          prerelease: false
          generate_release_notes: true
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: å‘å¸ƒå®Œæˆæç¤º
        run: |
          echo "ðŸŽ‰ Release ${{ steps.get_version.outputs.version }} åˆ›å»ºæˆåŠŸ!"
          echo "ðŸ“¥ ç”¨æˆ·å¯ä»¥ä»Ž GitHub Releases é¡µé¢ä¸‹è½½å¯¹åº”å¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶"
          echo "ðŸ–¥ï¸  ä¸‹è½½åŽç›´æŽ¥è¿è¡Œå³å¯å¯åŠ¨ TUI ç•Œé¢"